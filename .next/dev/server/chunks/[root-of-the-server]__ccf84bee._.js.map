{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/alifisk/project/gita-fashion-pos/src/lib/schema.ts"],"sourcesContent":["import { sqliteTable, text, integer, real } from 'drizzle-orm/sqlite-core'\nimport { relations } from 'drizzle-orm'\n\n// Users table\nexport const users = sqliteTable('users', {\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\n  email: text('email').notNull().unique(),\n  name: text('name').notNull(),\n  password: text('password').notNull(),\n  role: text('role', { enum: ['ADMIN', 'MANAGER', 'CASHIER'] }).notNull().default('CASHIER'),\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n})\n\n// Categories table\nexport const categories = sqliteTable('categories', {\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\n  name: text('name').notNull().unique(),\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n})\n\n// Products table\nexport const products = sqliteTable('products', {\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\n  barcode: text('barcode').notNull().unique(),\n  name: text('name').notNull(),\n  categoryId: text('category_id').references(() => categories.id),\n  initialStock: integer('initial_stock').notNull().default(0),\n  currentStock: integer('current_stock').notNull().default(0),\n  sellPrice: real('sell_price').notNull(),\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n})\n\n// Transactions table\nexport const transactions = sqliteTable('transactions', {\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\n  code: text('code').notNull().unique(),\n  transactionDate: integer('transaction_date', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  totalItems: integer('total_items').notNull(),\n  cashAmount: real('cash_amount').notNull().default(0),\n  transferAmount: real('transfer_amount').notNull().default(0),\n  bankName: text('bank_name'),\n  paymentProof: text('payment_proof'),\n  paymentStatus: text('payment_status', { enum: ['PENDING', 'PAID', 'CANCELLED'] }).notNull().default('PENDING'),\n  userId: text('user_id').notNull().references(() => users.id),\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n})\n\n// Outgoing Items table\nexport const outgoingItems = sqliteTable('outgoing_items', {\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\n  date: integer('date', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  barcode: text('barcode').notNull(),\n  productName: text('product_name').notNull(),\n  quantity: integer('quantity').notNull(),\n  transactionCode: text('transaction_code').notNull().references(() => transactions.code),\n  price: real('price').notNull(),\n  discountPercent: real('discount_percent').notNull().default(0),\n  discountAmount: real('discount_amount').notNull().default(0),\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n})\n\n// Settings table\nexport const settings = sqliteTable('settings', {\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\n  key: text('key').notNull().unique(),\n  value: text('value').notNull(),\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n})\n\n// Shifts table (Tutup Kasir)\nexport const shifts = sqliteTable('shifts', {\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\n  userId: text('user_id').notNull().references(() => users.id),\n  startTime: integer('start_time', { mode: 'timestamp' }).notNull(),\n  endTime: integer('end_time', { mode: 'timestamp' }),\n  startingCash: real('starting_cash').notNull().default(0),\n  endingCash: real('ending_cash'),\n  totalSales: real('total_sales').default(0),\n  totalTransactions: integer('total_transactions').default(0),\n  totalExpenses: real('total_expenses').default(0),\n  status: text('status', { enum: ['OPEN', 'CLOSED'] }).notNull().default('OPEN'),\n  notes: text('notes'),\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n})\n\n// Expenses table (Pengeluaran)\nexport const expenses = sqliteTable('expenses', {\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\n  shiftId: text('shift_id').references(() => shifts.id),\n  userId: text('user_id').notNull().references(() => users.id),\n  category: text('category').notNull(), // 'OPERATIONAL', 'INVENTORY', 'MAINTENANCE', 'OTHER'\n  description: text('description').notNull(),\n  amount: real('amount').notNull(),\n  receipt: text('receipt'), // Optional receipt/proof\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\n})\n\n// Relations\nexport const usersRelations = relations(users, ({ many }) => ({\n  transactions: many(transactions),\n}))\n\nexport const categoriesRelations = relations(categories, ({ many }) => ({\n  products: many(products),\n}))\n\nexport const productsRelations = relations(products, ({ one, many }) => ({\n  category: one(categories, {\n    fields: [products.categoryId],\n    references: [categories.id],\n  }),\n  outgoingItems: many(outgoingItems),\n}))\n\nexport const transactionsRelations = relations(transactions, ({ one, many }) => ({\n  user: one(users, {\n    fields: [transactions.userId],\n    references: [users.id],\n  }),\n  outgoingItems: many(outgoingItems),\n}))\n\nexport const outgoingItemsRelations = relations(outgoingItems, ({ one }) => ({\n  transaction: one(transactions, {\n    fields: [outgoingItems.transactionCode],\n    references: [transactions.code],\n  }),\n  product: one(products, {\n    fields: [outgoingItems.barcode],\n    references: [products.barcode],\n  }),\n}))"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 277, "column": 0}, "map": {"version":3,"sources":["file:///Users/alifisk/project/gita-fashion-pos/src/lib/db.ts"],"sourcesContent":["import Database from 'better-sqlite3'\nimport { drizzle } from 'drizzle-orm/better-sqlite3'\nimport * as schema from './schema'\n\n// Get database path from environment variable or use default\nconst dbPath = process.env.DATABASE_URL?.replace('file:', '') || 'sqlite.db'\n\n// Lazy initialization - only create connection when first accessed\nlet _db: ReturnType<typeof drizzle> | null = null\n\nfunction getDb() {\n  if (!_db) {\n    const sqlite = new Database(dbPath)\n    _db = drizzle(sqlite, { schema })\n  }\n  return _db\n}\n\n// Export as a getter to ensure lazy initialization\nexport const db = new Proxy({} as ReturnType<typeof drizzle>, {\n  get(target, prop) {\n    return getDb()[prop as keyof ReturnType<typeof drizzle>]\n  }\n})\n\nexport default db"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEA,6DAA6D;AAC7D,MAAM,SAAS,QAAQ,GAAG,CAAC,YAAY,EAAE,QAAQ,SAAS,OAAO;AAEjE,mEAAmE;AACnE,IAAI,MAAyC;AAE7C,SAAS;IACP,IAAI,CAAC,KAAK;QACR,MAAM,SAAS,IAAI,sIAAQ,CAAC;QAC5B,MAAM,IAAA,0KAAO,EAAC,QAAQ;YAAE,QAAA;QAAO;IACjC;IACA,OAAO;AACT;AAGO,MAAM,KAAK,IAAI,MAAM,CAAC,GAAiC;IAC5D,KAAI,MAAM,EAAE,IAAI;QACd,OAAO,OAAO,CAAC,KAAyC;IAC1D;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 336, "column": 0}, "map": {"version":3,"sources":["file:///Users/alifisk/project/gita-fashion-pos/src/lib/auth-simple.ts"],"sourcesContent":["import { cookies } from 'next/headers'\nimport { db } from './db'\nimport { users } from './schema'\nimport { eq } from 'drizzle-orm'\nimport bcrypt from 'bcryptjs'\nimport jwt from 'jsonwebtoken'\nimport { NextRequest } from 'next/server'\n\nconst JWT_SECRET = process.env.NEXTAUTH_SECRET || 'gita-fashion-secret-key-2024'\n\nexport interface User {\n  id: string\n  email: string\n  name: string\n  role: string\n}\n\nexport async function signIn(email: string, password: string): Promise<User | null> {\n  try {\n    const [user] = await db.select().from(users).where(eq(users.email, email)).limit(1)\n\n    if (!user) {\n      return null\n    }\n\n    const isPasswordValid = await bcrypt.compare(password, user.password)\n    if (!isPasswordValid) {\n      return null\n    }\n\n    return {\n      id: user.id,\n      email: user.email,\n      name: user.name,\n      role: user.role\n    }\n  } catch (error) {\n    console.error('Sign in error:', error)\n    return null\n  }\n}\n\nexport function createToken(user: User): string {\n  return jwt.sign(user, JWT_SECRET, { expiresIn: '7d' })\n}\n\nexport function verifyToken(token: string): User | null {\n  try {\n    return jwt.verify(token, JWT_SECRET) as User\n  } catch (error) {\n    return null\n  }\n}\n\nexport async function getSession(request?: NextRequest): Promise<User | null> {\n  try {\n    let token: string | undefined\n\n    if (request) {\n      // For API routes with request object\n      token = request.cookies.get('auth-token')?.value\n    } else {\n      // For server components - simplified approach\n      try {\n        const cookieStore = await cookies()\n        token = cookieStore.get('auth-token')?.value\n      } catch (cookieError) {\n        // Fallback - return null if cookies not available\n        return null\n      }\n    }\n\n    if (!token) {\n      return null\n    }\n\n    return verifyToken(token)\n  } catch (error) {\n    console.error('Get session error:', error)\n    return null\n  }\n}"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;AAGA,MAAM,aAAa,QAAQ,GAAG,CAAC,eAAe,IAAI;AAS3C,eAAe,OAAO,KAAa,EAAE,QAAgB;IAC1D,IAAI;QACF,MAAM,CAAC,KAAK,GAAG,MAAM,wHAAE,CAAC,MAAM,GAAG,IAAI,CAAC,+HAAK,EAAE,KAAK,CAAC,IAAA,0KAAE,EAAC,+HAAK,CAAC,KAAK,EAAE,QAAQ,KAAK,CAAC;QAEjF,IAAI,CAAC,MAAM;YACT,OAAO;QACT;QAEA,MAAM,kBAAkB,MAAM,8IAAM,CAAC,OAAO,CAAC,UAAU,KAAK,QAAQ;QACpE,IAAI,CAAC,iBAAiB;YACpB,OAAO;QACT;QAEA,OAAO;YACL,IAAI,KAAK,EAAE;YACX,OAAO,KAAK,KAAK;YACjB,MAAM,KAAK,IAAI;YACf,MAAM,KAAK,IAAI;QACjB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO;IACT;AACF;AAEO,SAAS,YAAY,IAAU;IACpC,OAAO,kJAAG,CAAC,IAAI,CAAC,MAAM,YAAY;QAAE,WAAW;IAAK;AACtD;AAEO,SAAS,YAAY,KAAa;IACvC,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAEO,eAAe,WAAW,OAAqB;IACpD,IAAI;QACF,IAAI;QAEJ,IAAI,SAAS;YACX,qCAAqC;YACrC,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,eAAe;QAC7C,OAAO;YACL,8CAA8C;YAC9C,IAAI;gBACF,MAAM,cAAc,MAAM,IAAA,4IAAO;gBACjC,QAAQ,YAAY,GAAG,CAAC,eAAe;YACzC,EAAE,OAAO,aAAa;gBACpB,kDAAkD;gBAClD,OAAO;YACT;QACF;QAEA,IAAI,CAAC,OAAO;YACV,OAAO;QACT;QAEA,OAAO,YAAY;IACrB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 421, "column": 0}, "map": {"version":3,"sources":["file:///Users/alifisk/project/gita-fashion-pos/src/app/api/import/transactions/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { db } from '@/lib/db'\nimport { transactions, outgoingItems, users } from '@/lib/schema'\nimport { getSession } from '@/lib/auth-simple'\nimport { eq } from 'drizzle-orm'\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getSession(request)\n    if (!session || session.role !== 'ADMIN') {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const formData = await request.formData()\n    const file = formData.get('file') as File\n\n    if (!file) {\n      return NextResponse.json({ error: 'No file uploaded' }, { status: 400 })\n    }\n\n    if (!file.name.endsWith('.csv')) {\n      return NextResponse.json({ error: 'File must be CSV format' }, { status: 400 })\n    }\n\n    const content = await file.text()\n    const lines = content.trim().split('\\n')\n    \n    if (lines.length < 2) {\n      return NextResponse.json({ error: 'CSV file is empty' }, { status: 400 })\n    }\n\n    const headers = lines[0].split(',').map(h => h.trim().replace(/\"/g, ''))\n    console.log('CSV Headers:', headers)\n    \n    // Detect CSV format\n    const hasDetailColumns = headers.includes('barcode') || headers.includes('productName')\n    const hasSummaryColumns = headers.includes('Kode Transaksi') || headers.includes('Tanggal Transaksi')\n    \n    console.log('CSV Format:', { hasDetailColumns, hasSummaryColumns })\n    \n    // Parse CSV\n    const rows = []\n    for (let i = 1; i < lines.length; i++) {\n      if (!lines[i].trim()) continue\n      \n      const values = lines[i].match(/(\".*?\"|[^,]+)(?=\\s*,|\\s*$)/g) || []\n      const row: any = {}\n      \n      headers.forEach((header, index) => {\n        let value = values[index] ? values[index].trim().replace(/^\"|\"$/g, '') : ''\n        row[header] = value\n      })\n      \n      rows.push(row)\n    }\n    \n    console.log(`Parsed ${rows.length} rows from CSV`)\n    if (rows.length > 0) {\n      console.log('First row sample:', rows[0])\n    }\n    \n    // Handle summary format (without items)\n    if (hasSummaryColumns && !hasDetailColumns) {\n      return NextResponse.json({ \n        error: 'Format CSV tidak didukung', \n        details: 'File CSV harus berisi detail items (barcode, productName, quantity, price). Format summary transaksi tidak didukung.'\n      }, { status: 400 })\n    }\n\n    // Group by transaction\n    const transactionsMap: any = {}\n    let skippedRows = 0\n    \n    rows.forEach((row, index) => {\n      const code = row.code || row.transactionCode\n      const transactionDate = row.transactionDate || row.date\n      \n      // Debug first few rows\n      if (index < 3) {\n        console.log(`Row ${index + 2} data:`, { code, transactionDate, barcode: row.barcode })\n      }\n      \n      // Skip rows with missing or invalid data\n      if (!code || code.trim() === '') {\n        console.warn(`Row ${index + 2}: Missing code`)\n        skippedRows++\n        return\n      }\n      \n      if (!transactionDate || transactionDate.trim() === '' || transactionDate === '#N/A') {\n        console.warn(`Row ${index + 2}: Invalid date for code ${code}`)\n        skippedRows++\n        return\n      }\n      \n      if (!transactionsMap[code]) {\n        transactionsMap[code] = {\n          code: code,\n          transactionDate: transactionDate,\n          cashAmount: parseFloat(row.cashAmount || 0),\n          transferAmount: parseFloat(row.transferAmount || 0),\n          bankName: row.bankName || null,\n          paymentStatus: row.paymentStatus || 'PAID',\n          userId: row.userId || session.id,\n          items: []\n        }\n      }\n      \n      transactionsMap[code].items.push({\n        barcode: row.barcode,\n        productName: row.productName,\n        quantity: parseInt(row.quantity || 1),\n        price: parseFloat(row.price || 0),\n        discountPercent: parseFloat(row.discountPercent || 0),\n        discountAmount: parseFloat(row.discountAmount || 0)\n      })\n    })\n\n    const transactionsList = Object.values(transactionsMap)\n    console.log(`Grouped into ${transactionsList.length} transactions`)\n    \n    // Calculate totalItems\n    transactionsList.forEach((t: any) => {\n      t.totalItems = t.items.reduce((sum: number, item: any) => sum + item.quantity, 0)\n    })\n\n    let successCount = 0\n    let skipCount = 0\n    let errorCount = 0\n    const errors: string[] = []\n\n    // Import transactions\n    for (const transaction of transactionsList) {\n      try {\n        // Check if exists\n        const existing = await db.select().from(transactions).where(eq(transactions.code, transaction.code)).limit(1)\n        \n        if (existing.length > 0) {\n          skipCount++\n          continue\n        }\n\n        // Parse date\n        let dateStr = transaction.transactionDate.replace(/(\\d{2})\\.(\\d{2})\\.(\\d{2})/, '$1:$2:$3')\n        const dateObj = new Date(dateStr)\n        const transactionDate = Math.floor(dateObj.getTime() / 1000)\n        const now = Math.floor(Date.now() / 1000)\n\n        // Insert transaction\n        await db.insert(transactions).values({\n          id: crypto.randomUUID(),\n          code: transaction.code,\n          transactionDate: new Date(transactionDate * 1000),\n          totalItems: transaction.totalItems,\n          cashAmount: transaction.cashAmount,\n          transferAmount: transaction.transferAmount,\n          bankName: transaction.bankName,\n          paymentStatus: transaction.paymentStatus,\n          userId: transaction.userId,\n          createdAt: new Date(transactionDate * 1000),\n          updatedAt: new Date(now * 1000)\n        })\n\n        // Insert items\n        for (const item of transaction.items) {\n          await db.insert(outgoingItems).values({\n            id: crypto.randomUUID(),\n            date: new Date(transactionDate * 1000),\n            barcode: item.barcode,\n            productName: item.productName,\n            quantity: item.quantity,\n            transactionCode: transaction.code,\n            price: item.price,\n            discountPercent: item.discountPercent || 0,\n            discountAmount: item.discountAmount || 0,\n            createdAt: new Date(now * 1000)\n          })\n        }\n\n        successCount++\n      } catch (error) {\n        errorCount++\n        errors.push(`${transaction.code}: ${error instanceof Error ? error.message : 'Unknown error'}`)\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: `Import completed. ${skippedRows} rows skipped due to invalid data.`,\n      summary: {\n        total: transactionsList.length,\n        success: successCount,\n        skipped: skipCount,\n        failed: errorCount,\n        invalidRows: skippedRows\n      },\n      errors: errors.slice(0, 10)\n    })\n\n  } catch (error) {\n    console.error('Import error:', error)\n    return NextResponse.json({ \n      error: 'Import failed', \n      details: error instanceof Error ? error.message : 'Unknown error'\n    }, { status: 500 })\n  }\n}\n\nexport const runtime = 'nodejs'\n"],"names":[],"mappings":"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","debugId":null}}]
}