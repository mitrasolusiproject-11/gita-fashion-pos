{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///D:/Project/KIRO/Gita%20Fashion/gita-fashion/src/lib/schema.ts"],"sourcesContent":["import { sqliteTable, text, integer, real } from 'drizzle-orm/sqlite-core'\r\nimport { relations } from 'drizzle-orm'\r\n\r\n// Users table\r\nexport const users = sqliteTable('users', {\r\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\r\n  email: text('email').notNull().unique(),\r\n  name: text('name').notNull(),\r\n  password: text('password').notNull(),\r\n  role: text('role', { enum: ['ADMIN', 'MANAGER', 'CASHIER'] }).notNull().default('CASHIER'),\r\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n})\r\n\r\n// Categories table\r\nexport const categories = sqliteTable('categories', {\r\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\r\n  name: text('name').notNull().unique(),\r\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n})\r\n\r\n// Products table\r\nexport const products = sqliteTable('products', {\r\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\r\n  barcode: text('barcode').notNull().unique(),\r\n  name: text('name').notNull(),\r\n  categoryId: text('category_id').references(() => categories.id),\r\n  initialStock: integer('initial_stock').notNull().default(0),\r\n  currentStock: integer('current_stock').notNull().default(0),\r\n  sellPrice: real('sell_price').notNull(),\r\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n})\r\n\r\n// Transactions table\r\nexport const transactions = sqliteTable('transactions', {\r\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\r\n  code: text('code').notNull().unique(),\r\n  transactionDate: integer('transaction_date', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n  totalItems: integer('total_items').notNull(),\r\n  cashAmount: real('cash_amount').notNull().default(0),\r\n  transferAmount: real('transfer_amount').notNull().default(0),\r\n  bankName: text('bank_name'),\r\n  paymentProof: text('payment_proof'),\r\n  paymentStatus: text('payment_status', { enum: ['PENDING', 'PAID', 'CANCELLED'] }).notNull().default('PENDING'),\r\n  userId: text('user_id').notNull().references(() => users.id),\r\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n})\r\n\r\n// Outgoing Items table\r\nexport const outgoingItems = sqliteTable('outgoing_items', {\r\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\r\n  date: integer('date', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n  barcode: text('barcode').notNull(),\r\n  productName: text('product_name').notNull(),\r\n  quantity: integer('quantity').notNull(),\r\n  transactionCode: text('transaction_code').notNull().references(() => transactions.code),\r\n  price: real('price').notNull(),\r\n  discountPercent: real('discount_percent').notNull().default(0),\r\n  discountAmount: real('discount_amount').notNull().default(0),\r\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n})\r\n\r\n// Settings table\r\nexport const settings = sqliteTable('settings', {\r\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\r\n  key: text('key').notNull().unique(),\r\n  value: text('value').notNull(),\r\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n})\r\n\r\n// Shifts table (Tutup Kasir)\r\nexport const shifts = sqliteTable('shifts', {\r\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\r\n  userId: text('user_id').notNull().references(() => users.id),\r\n  startTime: integer('start_time', { mode: 'timestamp' }).notNull(),\r\n  endTime: integer('end_time', { mode: 'timestamp' }),\r\n  startingCash: real('starting_cash').notNull().default(0),\r\n  endingCash: real('ending_cash'),\r\n  totalSales: real('total_sales').default(0),\r\n  totalTransactions: integer('total_transactions').default(0),\r\n  totalExpenses: real('total_expenses').default(0),\r\n  status: text('status', { enum: ['OPEN', 'CLOSED'] }).notNull().default('OPEN'),\r\n  notes: text('notes'),\r\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n})\r\n\r\n// Expenses table (Pengeluaran)\r\nexport const expenses = sqliteTable('expenses', {\r\n  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),\r\n  shiftId: text('shift_id').references(() => shifts.id),\r\n  userId: text('user_id').notNull().references(() => users.id),\r\n  category: text('category').notNull(), // 'OPERATIONAL', 'INVENTORY', 'MAINTENANCE', 'OTHER'\r\n  description: text('description').notNull(),\r\n  amount: real('amount').notNull(),\r\n  receipt: text('receipt'), // Optional receipt/proof\r\n  createdAt: integer('created_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n  updatedAt: integer('updated_at', { mode: 'timestamp' }).$defaultFn(() => new Date()),\r\n})\r\n\r\n// Relations\r\nexport const usersRelations = relations(users, ({ many }) => ({\r\n  transactions: many(transactions),\r\n}))\r\n\r\nexport const categoriesRelations = relations(categories, ({ many }) => ({\r\n  products: many(products),\r\n}))\r\n\r\nexport const productsRelations = relations(products, ({ one, many }) => ({\r\n  category: one(categories, {\r\n    fields: [products.categoryId],\r\n    references: [categories.id],\r\n  }),\r\n  outgoingItems: many(outgoingItems),\r\n}))\r\n\r\nexport const transactionsRelations = relations(transactions, ({ one, many }) => ({\r\n  user: one(users, {\r\n    fields: [transactions.userId],\r\n    references: [users.id],\r\n  }),\r\n  outgoingItems: many(outgoingItems),\r\n}))\r\n\r\nexport const outgoingItemsRelations = relations(outgoingItems, ({ one }) => ({\r\n  transaction: one(transactions, {\r\n    fields: [outgoingItems.transactionCode],\r\n    references: [transactions.code],\r\n  }),\r\n  product: one(products, {\r\n    fields: [outgoingItems.barcode],\r\n    references: [products.barcode],\r\n  }),\r\n}))"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 277, "column": 0}, "map": {"version":3,"sources":["file:///D:/Project/KIRO/Gita%20Fashion/gita-fashion/src/lib/db.ts"],"sourcesContent":["import Database from 'better-sqlite3'\r\nimport { drizzle } from 'drizzle-orm/better-sqlite3'\r\nimport * as schema from './schema'\r\n\r\nconst sqlite = new Database('sqlite.db')\r\nexport const db = drizzle(sqlite, { schema })\r\n\r\nexport default db"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEA,MAAM,SAAS,IAAI,sIAAQ,CAAC;AACrB,MAAM,KAAK,IAAA,0KAAO,EAAC,QAAQ;IAAE,QAAA;AAAO;uCAE5B","debugId":null}},
    {"offset": {"line": 322, "column": 0}, "map": {"version":3,"sources":["file:///D:/Project/KIRO/Gita%20Fashion/gita-fashion/src/lib/auth-simple.ts"],"sourcesContent":["import { cookies } from 'next/headers'\r\nimport { db } from './db'\r\nimport { users } from './schema'\r\nimport { eq } from 'drizzle-orm'\r\nimport bcrypt from 'bcryptjs'\r\nimport jwt from 'jsonwebtoken'\r\nimport { NextRequest } from 'next/server'\r\n\r\nconst JWT_SECRET = process.env.NEXTAUTH_SECRET || 'gita-fashion-secret-key-2024'\r\n\r\nexport interface User {\r\n  id: string\r\n  email: string\r\n  name: string\r\n  role: string\r\n}\r\n\r\nexport async function signIn(email: string, password: string): Promise<User | null> {\r\n  try {\r\n    const [user] = await db.select().from(users).where(eq(users.email, email)).limit(1)\r\n\r\n    if (!user) {\r\n      return null\r\n    }\r\n\r\n    const isPasswordValid = await bcrypt.compare(password, user.password)\r\n    if (!isPasswordValid) {\r\n      return null\r\n    }\r\n\r\n    return {\r\n      id: user.id,\r\n      email: user.email,\r\n      name: user.name,\r\n      role: user.role\r\n    }\r\n  } catch (error) {\r\n    console.error('Sign in error:', error)\r\n    return null\r\n  }\r\n}\r\n\r\nexport function createToken(user: User): string {\r\n  return jwt.sign(user, JWT_SECRET, { expiresIn: '7d' })\r\n}\r\n\r\nexport function verifyToken(token: string): User | null {\r\n  try {\r\n    return jwt.verify(token, JWT_SECRET) as User\r\n  } catch (error) {\r\n    return null\r\n  }\r\n}\r\n\r\nexport async function getSession(request?: NextRequest): Promise<User | null> {\r\n  try {\r\n    let token: string | undefined\r\n\r\n    if (request) {\r\n      // For API routes with request object\r\n      token = request.cookies.get('auth-token')?.value\r\n    } else {\r\n      // For server components - simplified approach\r\n      try {\r\n        const cookieStore = await cookies()\r\n        token = cookieStore.get('auth-token')?.value\r\n      } catch (cookieError) {\r\n        // Fallback - return null if cookies not available\r\n        return null\r\n      }\r\n    }\r\n\r\n    if (!token) {\r\n      return null\r\n    }\r\n\r\n    return verifyToken(token)\r\n  } catch (error) {\r\n    console.error('Get session error:', error)\r\n    return null\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;AAGA,MAAM,aAAa,QAAQ,GAAG,CAAC,eAAe,IAAI;AAS3C,eAAe,OAAO,KAAa,EAAE,QAAgB;IAC1D,IAAI;QACF,MAAM,CAAC,KAAK,GAAG,MAAM,wHAAE,CAAC,MAAM,GAAG,IAAI,CAAC,+HAAK,EAAE,KAAK,CAAC,IAAA,0KAAE,EAAC,+HAAK,CAAC,KAAK,EAAE,QAAQ,KAAK,CAAC;QAEjF,IAAI,CAAC,MAAM;YACT,OAAO;QACT;QAEA,MAAM,kBAAkB,MAAM,8IAAM,CAAC,OAAO,CAAC,UAAU,KAAK,QAAQ;QACpE,IAAI,CAAC,iBAAiB;YACpB,OAAO;QACT;QAEA,OAAO;YACL,IAAI,KAAK,EAAE;YACX,OAAO,KAAK,KAAK;YACjB,MAAM,KAAK,IAAI;YACf,MAAM,KAAK,IAAI;QACjB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO;IACT;AACF;AAEO,SAAS,YAAY,IAAU;IACpC,OAAO,kJAAG,CAAC,IAAI,CAAC,MAAM,YAAY;QAAE,WAAW;IAAK;AACtD;AAEO,SAAS,YAAY,KAAa;IACvC,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAEO,eAAe,WAAW,OAAqB;IACpD,IAAI;QACF,IAAI;QAEJ,IAAI,SAAS;YACX,qCAAqC;YACrC,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,eAAe;QAC7C,OAAO;YACL,8CAA8C;YAC9C,IAAI;gBACF,MAAM,cAAc,MAAM,IAAA,4IAAO;gBACjC,QAAQ,YAAY,GAAG,CAAC,eAAe;YACzC,EAAE,OAAO,aAAa;gBACpB,kDAAkD;gBAClD,OAAO;YACT;QACF;QAEA,IAAI,CAAC,OAAO;YACV,OAAO;QACT;QAEA,OAAO,YAAY;IACrB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 407, "column": 0}, "map": {"version":3,"sources":["file:///D:/Project/KIRO/Gita%20Fashion/gita-fashion/src/app/api/restore/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { db } from '@/lib/db'\r\nimport { getSession } from '@/lib/auth-simple'\r\nimport { \r\n  users, \r\n  categories, \r\n  products, \r\n  transactions, \r\n  outgoingItems, \r\n  settings, \r\n  shifts, \r\n  expenses \r\n} from '@/lib/schema'\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const session = await getSession(request)\r\n    if (!session || session.role !== 'ADMIN') {\r\n      return NextResponse.json({ error: 'Unauthorized - Admin access required' }, { status: 401 })\r\n    }\r\n\r\n    const formData = await request.formData()\r\n    const file = formData.get('file') as File\r\n\r\n    if (!file) {\r\n      return NextResponse.json({ error: 'No backup file uploaded' }, { status: 400 })\r\n    }\r\n\r\n    if (!file.name.endsWith('.json')) {\r\n      return NextResponse.json({ error: 'Invalid file format. Please upload a JSON backup file.' }, { status: 400 })\r\n    }\r\n\r\n    const text = await file.text()\r\n    let backupData: any\r\n\r\n    try {\r\n      backupData = JSON.parse(text)\r\n    } catch (error) {\r\n      return NextResponse.json({ error: 'Invalid JSON format' }, { status: 400 })\r\n    }\r\n\r\n    // Validate backup structure\r\n    if (!backupData.metadata || !backupData.data) {\r\n      return NextResponse.json({ error: 'Invalid backup file structure' }, { status: 400 })\r\n    }\r\n\r\n    const { data } = backupData\r\n    let restoredCount = 0\r\n    const errors: string[] = []\r\n\r\n    try {\r\n      // Clear existing data first (safer approach)\r\n      console.log('üóëÔ∏è Clearing existing data...')\r\n      \r\n      // Delete in reverse order of dependencies\r\n      await db.delete(outgoingItems)\r\n      await db.delete(transactions)\r\n      await db.delete(expenses)\r\n      await db.delete(shifts)\r\n      await db.delete(products)\r\n      await db.delete(categories)\r\n      // Keep users for authentication\r\n      \r\n      console.log('‚úÖ Existing data cleared')\r\n      \r\n      // Restore in order to respect foreign key constraints\r\n      \r\n      // 1. Categories first (no dependencies)\r\n      if (data.categories && Array.isArray(data.categories)) {\r\n        console.log(`üìÇ Restoring ${data.categories.length} categories...`)\r\n        for (const category of data.categories) {\r\n          try {\r\n            await db.insert(categories).values({\r\n              id: category.id,\r\n              name: category.name,\r\n              createdAt: new Date(category.createdAt),\r\n              updatedAt: new Date(category.updatedAt || category.createdAt)\r\n            })\r\n            restoredCount++\r\n          } catch (error) {\r\n            errors.push(`Category ${category.name}: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n          }\r\n        }\r\n        console.log(`‚úÖ Categories restored: ${data.categories.length}`)\r\n      }\r\n\r\n      // 2. Users (skip - keep existing users for authentication)\r\n      console.log('üë§ Skipping users restore (keeping existing users for security)')\r\n      \r\n      // Note: We don't restore users to prevent authentication issues\r\n      // Admin can manually recreate users if needed\r\n\r\n      // 3. Products (depends on categories)\r\n      if (data.products && Array.isArray(data.products)) {\r\n        console.log(`üì¶ Restoring ${data.products.length} products...`)\r\n        for (const product of data.products) {\r\n          try {\r\n            await db.insert(products).values({\r\n              id: product.id,\r\n              barcode: product.barcode,\r\n              name: product.name,\r\n              categoryId: product.categoryId,\r\n              initialStock: product.initialStock,\r\n              currentStock: product.currentStock,\r\n              sellPrice: product.sellPrice,\r\n              createdAt: new Date(product.createdAt),\r\n              updatedAt: new Date(product.updatedAt || product.createdAt)\r\n            })\r\n            restoredCount++\r\n          } catch (error) {\r\n            errors.push(`Product ${product.name}: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n          }\r\n        }\r\n        console.log(`‚úÖ Products restored: ${data.products.length}`)\r\n      }\r\n\r\n      // 4. Settings\r\n      if (data.settings && Array.isArray(data.settings)) {\r\n        for (const setting of data.settings) {\r\n          try {\r\n            await db.insert(settings).values(setting).onConflictDoUpdate({\r\n              target: settings.key,\r\n              set: {\r\n                value: setting.value,\r\n                updatedAt: new Date()\r\n              }\r\n            })\r\n            restoredCount++\r\n          } catch (error) {\r\n            errors.push(`Setting ${setting.key}: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n          }\r\n        }\r\n      }\r\n\r\n      // 5. Transactions (depends on users)\r\n      if (data.transactions && Array.isArray(data.transactions)) {\r\n        for (const transaction of data.transactions) {\r\n          try {\r\n            await db.insert(transactions).values(transaction).onConflictDoUpdate({\r\n              target: transactions.code,\r\n              set: {\r\n                totalItems: transaction.totalItems,\r\n                cashAmount: transaction.cashAmount,\r\n                transferAmount: transaction.transferAmount,\r\n                bankName: transaction.bankName,\r\n                paymentStatus: transaction.paymentStatus,\r\n                updatedAt: new Date()\r\n              }\r\n            })\r\n            restoredCount++\r\n          } catch (error) {\r\n            errors.push(`Transaction ${transaction.code}: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n          }\r\n        }\r\n      }\r\n\r\n      // 6. Outgoing Items (depends on transactions)\r\n      if (data.outgoingItems && Array.isArray(data.outgoingItems)) {\r\n        for (const item of data.outgoingItems) {\r\n          try {\r\n            await db.insert(outgoingItems).values(item)\r\n            restoredCount++\r\n          } catch (error) {\r\n            errors.push(`Outgoing Item ${item.id}: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n          }\r\n        }\r\n      }\r\n\r\n      // 7. Shifts (depends on users)\r\n      if (data.shifts && Array.isArray(data.shifts)) {\r\n        for (const shift of data.shifts) {\r\n          try {\r\n            await db.insert(shifts).values(shift).onConflictDoUpdate({\r\n              target: shifts.id,\r\n              set: {\r\n                endTime: shift.endTime,\r\n                endingCash: shift.endingCash,\r\n                totalSales: shift.totalSales,\r\n                totalTransactions: shift.totalTransactions,\r\n                totalExpenses: shift.totalExpenses,\r\n                status: shift.status,\r\n                notes: shift.notes,\r\n                updatedAt: new Date()\r\n              }\r\n            })\r\n            restoredCount++\r\n          } catch (error) {\r\n            errors.push(`Shift ${shift.id}: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n          }\r\n        }\r\n      }\r\n\r\n      // 8. Expenses (depends on users and shifts)\r\n      if (data.expenses && Array.isArray(data.expenses)) {\r\n        for (const expense of data.expenses) {\r\n          try {\r\n            await db.insert(expenses).values(expense)\r\n            restoredCount++\r\n          } catch (error) {\r\n            errors.push(`Expense ${expense.id}: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n          }\r\n        }\r\n      }\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        message: `Database restored successfully. ${restoredCount} records processed.`,\r\n        restoredCount,\r\n        errorCount: errors.length,\r\n        errors: errors.slice(0, 10), // Limit to first 10 errors\r\n        metadata: backupData.metadata\r\n      })\r\n\r\n    } catch (error) {\r\n      console.error('Error during restore:', error)\r\n      return NextResponse.json({ \r\n        error: 'Error during restore process', \r\n        details: error instanceof Error ? error.message : 'Unknown error'\r\n      }, { status: 500 })\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('Error restoring database:', error)\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\r\n  }\r\n}\r\n\r\nexport const runtime = 'nodejs'"],"names":[],"mappings":"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","debugId":null}}]
}